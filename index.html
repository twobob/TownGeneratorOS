<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Medieval Fantasy City Generator</title>
  <style>
    /* ==== COLOR VARIABLES ==== */
    :root {
      --tab-inactive-bg: #8b7355;
      --tab-inactive-text: #a57b7b;
      --tab-active-bg: rgba(255, 255, 255, 0.95);
      --tab-active-text: #2b2416;
      --tab-border: #4a3d2c;
      --tab-hover-bg: #6b5842;
    }
    /* ========================= */
    
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: #f3ede2;
      font-family: sans-serif;
    }
    #app {
      width: 100%;
      height: 100%;
      position: relative;
    }
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 100;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      font-family: sans-serif;
      max-height: calc(100vh - 20px);
      transition: transform 0.3s ease;
    }
    .controls.collapsed {
      transform: translateX(-100%);

    }
    .export-float {
      position: fixed;
      bottom: 10px;
      left: 10px;
      z-index: 101;
      display: none;
    }
    .controls.collapsed ~ .export-float {
      display: block;
    }
    .export-float button {
      background: #4a3d2c;
      color: #f3ede2;
      border: none;
      padding: 8px 16px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.85rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .export-float button:hover {
      background: #5d4d38;
    }
    .controls-toggle {
      position: absolute;
      top: 10px;
      right: -10px;
      width: 30px;
      height: 30px;
      background: rgba(255, 255, 255, 0.95);
      border: none;
      border-radius: 0 4px 4px 0;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.2);
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #4a3d2c;
    }
    .controls-toggle:hover {
      background: rgba(255, 255, 255, 1);
    }
    .edge-nudge{
      right: -30px;
    }
    .controls h3 {
      margin: 0 0 10px 0;
      font-size: 0.9rem;
      color: #4a3d2c;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .tab-nav {
      display: flex;
      gap: 4px;
      margin: -15px -15px 15px -15px;
      border-bottom: 2px solid var(--tab-border);
    }
    .tab-button {
      flex: 1;
      background: var(--tab-inactive-bg);
      border: none;
      padding: 10px 15px;
      cursor: pointer;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--tab-inactive-text);
      font-weight: 600;
      border-top: 2px solid transparent;
      transition: background 0.2s;
    }
    .tab-button:first-child {
      border-radius: 4px 0 0 0;
    }
    .tab-button:last-child {
      border-radius: 0 4px 0 0;
    }
    .tab-button:hover {
      background: var(--tab-hover-bg);
    }
    .tab-button.active {
      background: var(--tab-active-bg);
      color: var(--tab-active-text);
      border-top-color: var(--tab-border);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .controls label {
      display: block;
      margin-bottom: 2px;
      font-size: 0.85rem;
      color: #4a3d2c;
    }
    .checkbox-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 8px;
    }
    .checkbox-grid.three-col {
      grid-template-columns: repeat(3, 1fr);
    }
    .checkbox-grid label {
      margin-bottom: 0;
    }
    .radio-inline {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .radio-inline label {
      display: inline-flex;
      align-items: center;
      margin: 0;
      white-space: nowrap;
    }
    .slider-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .slider-grid label {
      margin-bottom: 0;
    }
    .controls input[type="range"] {
      width: 100%;
      margin: 2px 0;
    }
    .controls button {
      background: #4a3d2c;
      color: #f3ede2;
      border: none;
      padding: 8px 16px;
      margin: 8px 4px 0 0;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.85rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    .controls button:hover {
      background: #5d4d38;
    }
    .controls button:active {
      background: #2b2416;
    }
    canvas {
      display: block;
    }
    .loading-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #4a3d2c;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="loading-message">Loading city generator…</div>
  </div>
  <script src="src/towngenerator_new.js"></script>
  <script>
    (function () {
      function start() {
        var container = document.getElementById('app');
        if (!container) {
          throw new Error('Missing #app container for Town Generator');
        }

        container.querySelector('.loading-message').remove();

        // Pull URL parameters first
        StateManager.pullParams();

        var generator = new TownGenerator();
        generator.init(container);

        var controls = document.createElement('div');
        controls.className = 'controls';
        controls.innerHTML = '<button class="controls-toggle" id="toggle-controls">◀</button>' +
          '<div class="tab-nav">' +
          '<button class="tab-button active" data-tab="settings">Settings</button>' +
          '<button class="tab-button" data-tab="colours">Colours</button>' +
          '</div>' +
          '<div class="tab-content active" id="tab-settings">' +
          '<label>Zoom: <span id="zoom-value">1.0</span><br>' +
          '<input type="range" id="zoom-slider" min="0.2" max="3" step="0.1" value="1.0"></label>' +
          '<label>Size: <span id="size-value">' + StateManager.size + '</span><br>' +
          '<input type="range" id="size-slider" min="6" max="40" value="' + StateManager.size + '"></label>' +
          '<div class="seed-row" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:start;margin-bottom:6px;">' +
            '<label style="margin:0;">Seed:<br><input type="number" id="seed-input" style="width: 120px; padding: 4px;" value="' + (StateManager.seed > 0 ? StateManager.seed : '') + '"></label>' +
            '<label style="margin:0;align-self:center;white-space:nowrap;"><input type="checkbox" id="view-architecture-check"> Use View Architecture</label>' +
          '</div>' +
          '<div class="checkbox-grid">' +
          '<label><input type="checkbox" id="plaza-check" checked> Plaza</label>' +
          '<label><input type="checkbox" id="region-names-check" checked> Region Names</label>' +
          '<label><input type="checkbox" id="walls-check" checked> Walls</label>' +
          '<label><input type="checkbox" id="labels-check"> Show Labels</label>' +
          '<label><input type="checkbox" id="shantytown-check" checked> Shantytown</label>' +
          '<label><input type="checkbox" id="buildings-check" checked> Show Buildings</label>' +
          '<label><input type="checkbox" id="citadel-check" checked> Citadel</label>' +
          '<label><input type="checkbox" id="show-water-check" checked> Show Water</label>' +
          '<label><input type="checkbox" id="urban-castle-check"> Urban Castle</label>' +
          '<label><input type="checkbox" id="streets-check" checked> Show Streets</label>' +
          '<div class="radio-inline">' +
          '<label><input type="radio" name="lots-mode" value="normal" > Norm</label>' +
          '<label><input type="radio" name="lots-mode" value="mix" checked> Mix</label>' +
          '<label><input type="radio" name="lots-mode" value="lots"> Lot</label>' +
          '</div>' +
          '<label><input type="checkbox" id="show-trees-check" checked> Show Trees</label>' +
          '</div>' +
          '<div class="slider-grid">' +
          '<label>Grid Chaos: <span id="grid-chaos-value">0.1</span><br>' +
          '<input type="range" id="grid-chaos" min="0" max="1" step="0.1" value="0.1"></label>' +
          '<label>Size Chaos: <span id="size-chaos-value">0.1</span><br>' +
          '<input type="range" id="size-chaos" min="0" max="1" step="0.1" value="0.1"></label>' +
          '<label>Cell Size Chaos: <span id="cell-chaos-value">0.9</span><br>' +
          '<input type="range" id="cell-chaos" min="0" max="1" step="0.1" value="0.9"></label>' +
          '<label>Alley Width: <span id="alley-width-value">0.7</span><br>' +
          '<input type="range" id="alley-width" min="0" max="3" step="0.1" value="0.7"></label>' +
          '<label>Street Width: <span id="street-width-value">3.5</span><br>' +
          '<input type="range" id="street-width" min="0.5" max="5" step="0.5" value="3.5"></label>' +
          '<label>Building Gap: <span id="building-gap-value">0.9</span><br>' +
          '<input type="range" id="building-gap" min="0" max="2" step="0.1" value="0.9"></label>' +
          '<label>Wall Thickness: <span id="wall-thickness-value">4.0</span><br>' +
          '<input type="range" id="wall-thickness" min="0.5" max="5" step="0.5" value="4.0"></label>' +
          '<label>Piazza Chance: <span id="plaza-chance-value">5%</span><br>' +
          '<input type="range" id="plaza-chance" min="0" max="1" step="0.05" value="0.05"></label>' +
          '</div>' +
          '<h3>Water</h3>' +
          '<div class="checkbox-grid three-col" id="water-grid">' +
          '<label><input type="checkbox" id="river-check" checked> River</label>' +
          '<label><input type="checkbox" id="canal-check" checked> Canal</label>' +
          '<label><input type="checkbox" id="coast-check" > Coast</label>' +
          '</div>' +
          '<div><button id="regenerate-btn">New Random</button>' +
          '<button id="apply-btn">Apply Settings</button>' +
          '<button id="export-btn">Export PNG</button></div>' +
          '</div>' + // End tab-settings
          '<div class="tab-content" id="tab-colours">' +
          '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">' +
          '<label style="margin:0;">Preset:</label>' +
          '<select id="color-preset" style="padding:4px 8px;border-radius:3px;border:1px solid #4a3d2c;background:#fff;">' +
          '<option value="default">Default</option>' +
          '<option value="ink">Ink</option>' +
          '<option value="bw">Black & White</option>' +
          '<option value="vivid">Vivid</option>' +
          '<option value="natural">Natural</option>' +
          '<option value="modern">Modern</option>' +
          '</select>' +
          '</div>' +
          '<div class="color-grid" style="display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center;margin-bottom:12px;">' +
          '<label style="margin:0;">Paper</label>' +
          '<input type="text" id="color-paper" value="" style="padding:4px;width:100%;font-family:monospace;font-size:0.85rem;">' +
          '<input type="color" id="color-paper-pick" value="#000000" style="width:40px;height:28px;border:1px solid #4a3d2c;cursor:pointer;">' +
          
          '<label style="margin:0;">Ink</label>' +
          '<input type="text" id="color-ink" value="" style="padding:4px;width:100%;font-family:monospace;font-size:0.85rem;">' +
          '<input type="color" id="color-ink-pick" value="#000000" style="width:40px;height:28px;border:1px solid #4a3d2c;cursor:pointer;">' +
          
          '<label style="margin:0;">Roofs</label>' +
          '<input type="text" id="color-roofs" value="" style="padding:4px;width:100%;font-family:monospace;font-size:0.85rem;">' +
          '<input type="color" id="color-roofs-pick" value="#000000" style="width:40px;height:28px;border:1px solid #4a3d2c;cursor:pointer;">' +
          
          '<label style="margin:0;">Water</label>' +
          '<input type="text" id="color-water" value="" style="padding:4px;width:100%;font-family:monospace;font-size:0.85rem;">' +
          '<input type="color" id="color-water-pick" value="#000000" style="width:40px;height:28px;border:1px solid #4a3d2c;cursor:pointer;">' +
          
          '<label style="margin:0;">Greens</label>' +
          '<input type="text" id="color-greens" value="" style="padding:4px;width:100%;font-family:monospace;font-size:0.85rem;">' +
          '<input type="color" id="color-greens-pick" value="#000000" style="width:40px;height:28px;border:1px solid #4a3d2c;cursor:pointer;">' +
          
          '<label style="margin:0;">Roads</label>' +
          '<input type="text" id="color-roads" value="" style="padding:4px;width:100%;font-family:monospace;font-size:0.85rem;">' +
          '<input type="color" id="color-roads-pick" value="#000000" style="width:40px;height:28px;border:1px solid #4a3d2c;cursor:pointer;">' +
          
          '<label style="margin:0;">Walls</label>' +
          '<input type="text" id="color-walls" value="" style="padding:4px;width:100%;font-family:monospace;font-size:0.85rem;">' +
          '<input type="color" id="color-walls-pick" value="#000000" style="width:40px;height:28px;border:1px solid #4a3d2c;cursor:pointer;">' +
          
          '<label style="margin:0;">Trees</label>' +
          '<input type="text" id="color-trees" value="" style="padding:4px;width:100%;font-family:monospace;font-size:0.85rem;">' +
          '<input type="color" id="color-trees-pick" value="#000000" style="width:40px;height:28px;border:1px solid #4a3d2c;cursor:pointer;">' +
          
          '<label style="margin:0;">Labels</label>' +
          '<input type="text" id="color-labels" value="" style="padding:4px;width:100%;font-family:monospace;font-size:0.85rem;">' +
          '<input type="color" id="color-labels-pick" value="#000000" style="width:40px;height:28px;border:1px solid #4a3d2c;cursor:pointer;">' +
          
          '<label style="margin:0;">Elements</label>' +
          '<input type="text" id="color-elements" value="" style="padding:4px;width:100%;font-family:monospace;font-size:0.85rem;">' +
          '<input type="color" id="color-elements-pick" value="#000000" style="width:40px;height:28px;border:1px solid #4a3d2c;cursor:pointer;">' +
          '</div>' +
          '<h3 style="margin-top:16px;">Tinting</h3>' +
          '<label>Method:<br>' +
          '<select id="tint-method" style="width:100%;padding:4px;border-radius:3px;border:1px solid #4a3d2c;background:#fff;margin-top:4px;">' +
          '<option value="spectrum">Spectrum</option>' +
          '<option value="brightness">Brightness</option>' +
          '<option value="overlay">Overlay</option>' +
          '</select></label>' +
          '<label style="margin-top:8px;">Strength: <span id="tint-strength-value">90%</span><br>' +
          '<input type="range" id="tint-strength" min="0" max="100" step="5" value="90"></label>' +
          '<label>Weathering: <span id="tint-weathering-value">90%</span><br>' +
          '<input type="range" id="tint-weathering" min="0" max="100" step="5" value="90"></label>' +
          '<div class="checkbox-grid" style="margin-top:12px;">' +
          '<label><input type="checkbox" id="thin-lines-check"> Thin Lines</label>' +
          '<label><input type="checkbox" id="tint-districts-check" checked> Tint Districts</label>' +
          '<label><input type="checkbox" id="weathered-roofs-check" checked> Weathered Roofs</label>' +
          '</div>' +
          '<div style="margin-top:12px;"><button id="apply-colors-btn">Apply Colours</button>' +
          '<button id="save-colors-btn">Save</button>' +
          '<button id="load-colors-btn">Load</button></div>' +
          '</div>'; // End tab-colours
        container.appendChild(controls);

        // Add floating export button
        var exportFloat = document.createElement('div');
        exportFloat.className = 'export-float';
        exportFloat.innerHTML = '<button id="export-btn-float">Export PNG</button>';
        container.appendChild(exportFloat);

        // ===== COLOR SCHEME SYSTEM =====
        const colorPresets = {
          default: {
            paper: '#F3EDE2', ink: '#2B2416', roofs: '#8B7355', water: '#50DAD3',
            greens: '#C8D4A8', roads: '#E1DBD5', walls: '#4C4C4C', trees: '#4A7C59',
            labels: '#662C28', elements: '#D8D8CD'
          },
          ink: {
            paper: '#FFFEF8', ink: '#000000', roofs: '#3F322C', water: '#8F9997',
            greens: '#8D927B', roads: '#E1DBD5', walls: '#4C4C4C', trees: '#777F66',
            labels: '#662C28', elements: '#D8D8CD'
          },
          bw: {
            paper: '#FFFFFF', ink: '#000000', roofs: '#666666', water: '#CCCCCC',
            greens: '#AAAAAA', roads: '#EEEEEE', walls: '#333333', trees: '#888888',
            labels: '#000000', elements: '#DDDDDD'
          },
          vivid: {
            paper: '#FFF8DC', ink: '#1A0A00', roofs: '#DC143C', water: '#1E90FF',
            greens: '#32CD32', roads: '#FFD700', walls: '#2F4F4F', trees: '#228B22',
            labels: '#8B0000', elements: '#FF6347'
          },
          natural: {
            paper: '#F5F5DC', ink: '#3E2723', roofs: '#8D6E63', water: '#4FC3F7',
            greens: '#9CCC65', roads: '#EFEBE9', walls: '#5D4037', trees: '#66BB6A',
            labels: '#6D4C41', elements: '#BCAAA4'
          },
          modern: {
            paper: '#ECEFF1', ink: '#263238', roofs: '#607D8B', water: '#00BCD4',
            greens: '#4CAF50', roads: '#CFD8DC', walls: '#455A64', trees: '#009688',
            labels: '#37474F', elements: '#B0BEC5'
          }
        };

        var sizeSlider = document.getElementById('size-slider');
        var sizeValue = document.getElementById('size-value');
        var seedInput = document.getElementById('seed-input');
        var gridChaos = document.getElementById('grid-chaos');
        var gridChaosValue = document.getElementById('grid-chaos-value');
        var sizeChaos = document.getElementById('size-chaos');
        var sizeChaosValue = document.getElementById('size-chaos-value');
        var cellChaos = document.getElementById('cell-chaos');
        var cellChaosValue = document.getElementById('cell-chaos-value');
        var alleyWidth = document.getElementById('alley-width');
        var alleyWidthValue = document.getElementById('alley-width-value');
        var streetWidth = document.getElementById('street-width');
        var streetWidthValue = document.getElementById('street-width-value');
        var buildingGap = document.getElementById('building-gap');
        var buildingGapValue = document.getElementById('building-gap-value');
        var wallThickness = document.getElementById('wall-thickness');
        var wallThicknessValue = document.getElementById('wall-thickness-value');
        var zoomSlider = document.getElementById('zoom-slider');
        var zoomValue = document.getElementById('zoom-value');
        var plazaChance = document.getElementById('plaza-chance');
        var plazaChanceValue = document.getElementById('plaza-chance-value');

        seedInput.value = StateManager.seed;

        // Update display values on input
        sizeSlider.addEventListener('input', function() {
          sizeValue.textContent = sizeSlider.value;
        });
        
        gridChaos.addEventListener('input', function() {
          gridChaosValue.textContent = gridChaos.value;
        });
        
        sizeChaos.addEventListener('input', function() {
          sizeChaosValue.textContent = sizeChaos.value;
        });
        
        cellChaos.addEventListener('input', function() {
          cellChaosValue.textContent = cellChaos.value;
        });
        
        alleyWidth.addEventListener('input', function() {
          alleyWidthValue.textContent = alleyWidth.value;
        });
        
        streetWidth.addEventListener('input', function() {
          streetWidthValue.textContent = streetWidth.value;
        });
        
        buildingGap.addEventListener('input', function() {
          buildingGapValue.textContent = buildingGap.value;
        });
        
        wallThickness.addEventListener('input', function() {
          wallThicknessValue.textContent = wallThickness.value;
        });
        
        zoomSlider.addEventListener('input', function() {
          zoomValue.textContent = parseFloat(zoomSlider.value).toFixed(1);
        });
        
        plazaChance.addEventListener('input', function() {
          plazaChanceValue.textContent = Math.round(parseFloat(plazaChance.value) * 100) + '%';
        });
        
        // Auto-apply on change (when released)
        sizeSlider.addEventListener('change', function() {
          StateManager.size = parseInt(sizeSlider.value);
          generator.generate();
        });
        
        gridChaos.addEventListener('change', function() {
          StateManager.gridChaos = parseFloat(gridChaos.value);
          generator.generate();
        });
        
        sizeChaos.addEventListener('change', function() {
          StateManager.sizeChaos = parseFloat(sizeChaos.value);
          generator.generate();
        });
        
        cellChaos.addEventListener('change', function() {
          StateManager.cellChaos = parseFloat(cellChaos.value);
          generator.generate();
        });
        
        alleyWidth.addEventListener('change', function() {
          StateManager.alleyWidth = parseFloat(alleyWidth.value);
          generator.generate();
        });
        
        streetWidth.addEventListener('change', function() {
          StateManager.streetWidth = parseFloat(streetWidth.value);
          generator.render();
        });
        
        buildingGap.addEventListener('change', function() {
          StateManager.buildingGap = parseFloat(buildingGap.value);
          generator.generate();
        });
        
        wallThickness.addEventListener('change', function() {
          StateManager.wallThickness = parseFloat(wallThickness.value);
          generator.render();  // Only re-render, don't regenerate the whole city
        });
        
        zoomSlider.addEventListener('change', function() {
          StateManager.zoom = parseFloat(zoomSlider.value);
          generator.render();
        });
        
        plazaChance.addEventListener('change', function() {
          StateManager.plazaChance = parseFloat(plazaChance.value);
          generator.generate();
        });
        
        seedInput.addEventListener('change', function() {
          var newSeed = parseInt(seedInput.value);
          if (!isNaN(newSeed) && newSeed > 0) {
            StateManager.seed = newSeed;
            generator.generate();
          }
        });
        
        document.getElementById('plaza-check').addEventListener('change', function() {
          StateManager.plazaNeeded = this.checked;
          generator.generate();
        });
        
        document.getElementById('citadel-check').addEventListener('change', function() {
          StateManager.citadelNeeded = this.checked;
          generator.generate();
        });
        
        document.getElementById('walls-check').addEventListener('change', function() {
          StateManager.wallsNeeded = this.checked;
          generator.generate();
        });
        
        document.getElementById('labels-check').addEventListener('change', function() {
          StateManager.showLabels = this.checked;
          generator.render();
        });
        
        document.getElementById('region-names-check').addEventListener('change', function() {
          StateManager.showRegionNames = this.checked;
          generator.generate();
        });
        
        
        document.getElementById('buildings-check').addEventListener('change', function() {
          StateManager.showBuildings = this.checked;
          generator.render();
        });
        
        document.getElementById('streets-check').addEventListener('change', function() {
          StateManager.showStreets = this.checked;
          generator.render();
        });
        
        document.getElementById('view-architecture-check').addEventListener('change', function() {
          StateManager.useViewArchitecture = this.checked;
          generator.render();
        });

        const shantyEl = document.getElementById('shantytown-check');
        if (shantyEl) {
          shantyEl.addEventListener('change', function() {
            StateManager.shantytown = this.checked;
            generator.generate();
          });
        }

        const lotsRadios = document.querySelectorAll('input[name="lots-mode"]');
        lotsRadios.forEach(radio => {
          radio.addEventListener('change', function() {
            if (this.value === 'lots') {
              StateManager.lotsMode = 'lots';
            } else if (this.value === 'normal') {
              StateManager.lotsMode = 'normal';
            } else if (this.value === 'mix') {
              StateManager.lotsMode = 'mix';
            }
            generator.generate();
          });
        });

        const urbanCastleEl = document.getElementById('urban-castle-check');
        if (urbanCastleEl) {
          urbanCastleEl.addEventListener('change', function() {
            StateManager.urbanCastle = this.checked;
            generator.generate();
          });
        }
        
        document.getElementById('show-trees-check').addEventListener('change', function() {
          StateManager.showTrees = this.checked;
          generator.render();
        });
        
        document.getElementById('show-water-check').addEventListener('change', function() {
          StateManager.showWater = this.checked;
          generator.render();
        });

        // River and Canal checkboxes (independent, can both be on)
        document.getElementById('river-check').addEventListener('change', function() {
          StateManager.river = this.checked ? 1 : 0;
          generator.generate();
        });
        
        document.getElementById('canal-check').addEventListener('change', function() {
          StateManager.canal = this.checked ? 1 : 0;
          generator.generate();
        });
        document.getElementById('coast-check').addEventListener('change', function() {
          StateManager.coast = this.checked ? 1 : 0;
          generator.generate();
        });

        // Sync initial UI state from StateManager after pullParams
        const syncCheckbox = (id, value) => {
          const el = document.getElementById(id); if (el) el.checked = !!value;
        };
        syncCheckbox('plaza-check', StateManager.plazaNeeded);
        syncCheckbox('citadel-check', StateManager.citadelNeeded);
        syncCheckbox('walls-check', StateManager.wallsNeeded);
        syncCheckbox('labels-check', StateManager.showLabels);
        syncCheckbox('region-names-check', StateManager.showRegionNames);
        syncCheckbox('buildings-check', StateManager.showBuildings);
        syncCheckbox('streets-check', StateManager.showStreets);
        syncCheckbox('show-water-check', StateManager.showWater);
        syncCheckbox('show-trees-check', StateManager.showTrees);
        syncCheckbox('shantytown-check', StateManager.shantytown);
        
        // Sync lots mode radio buttons
        const lotsValue = StateManager.lotsMode === true ? 'lots' : (StateManager.lotsMode || 'mix');
        const lotsRadio = document.querySelector(`input[name="lots-mode"][value="${lotsValue}"]`);
        if (lotsRadio) lotsRadio.checked = true;
        syncCheckbox('urban-castle-check', StateManager.urbanCastle);
        syncCheckbox('river-check', StateManager.river === 1);
        syncCheckbox('canal-check', StateManager.canal === 1);
        syncCheckbox('coast-check', StateManager.coast === 1);

        // Initialize StateManager from checked checkboxes (rendering options)
        const tintDistrictsEl = document.getElementById('tint-districts-check');
        if (tintDistrictsEl) StateManager.tintDistricts = tintDistrictsEl.checked;
        
        const weatheredRoofsEl = document.getElementById('weathered-roofs-check');
        if (weatheredRoofsEl) StateManager.weatheredRoofs = weatheredRoofsEl.checked;
        
        const thinLinesEl = document.getElementById('thin-lines-check');
        if (thinLinesEl) StateManager.thinLines = thinLinesEl.checked;
        
        // Initialize StateManager from slider values
        const tintMethodEl = document.getElementById('tint-method');
        if (tintMethodEl) StateManager.tintMethod = tintMethodEl.value;
        
        const tintStrengthEl = document.getElementById('tint-strength');
        if (tintStrengthEl) StateManager.tintStrength = parseInt(tintStrengthEl.value);
        
        const tintWeatheringEl = document.getElementById('tint-weathering');
        if (tintWeatheringEl) StateManager.tintWeathering = parseInt(tintWeatheringEl.value);
        
        // Initialize StateManager water features from checkboxes
        const riverEl = document.getElementById('river-check');
        if (riverEl) StateManager.river = riverEl.checked ? 1 : 0;
        
        const canalEl = document.getElementById('canal-check');
        if (canalEl) StateManager.canal = canalEl.checked ? 1 : 0;
        
        const coastEl = document.getElementById('coast-check');
        if (coastEl) StateManager.coast = coastEl.checked ? 1 : 0;

        // Make generator globally accessible for flythrough
        window.generator = generator;

        // Tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
          button.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');
            
            // Remove active from all tabs and buttons
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Add active to clicked button and corresponding content
            this.classList.add('active');
            document.getElementById('tab-' + targetTab).classList.add('active');
          });
        });

        // Toggle controls collapse
        document.getElementById('toggle-controls').addEventListener('click', function() {
          const controls = document.querySelector('.controls');
          const controlstoggle = document.getElementById('toggle-controls');
          const btn = this;
          if (controls.classList.contains('collapsed')) {
            controls.classList.remove('collapsed');
            controlstoggle.classList.remove('edge-nudge')
            btn.textContent = '◀';
          } else {
            controls.classList.add('collapsed');
            controlstoggle.classList.add('edge-nudge')
            btn.textContent = '▶';
          }
        });

        // 3D camera controls
        const cameraHeightSlider = document.getElementById('camera-height');
        const cameraHeightValue = document.getElementById('camera-height-value');
        const cameraFovSlider = document.getElementById('camera-fov');
        const cameraFovValue = document.getElementById('camera-fov-value');
        const cameraAngleSlider = document.getElementById('camera-angle');
        const cameraAngleValue = document.getElementById('camera-angle-value');
        const buildingCountSlider = document.getElementById('building-count');
        const buildingCountValue = document.getElementById('building-count-value');

        if (cameraHeightSlider) {
          cameraHeightSlider.addEventListener('input', function() {
            cameraHeightValue.textContent = cameraHeightSlider.value;
            StateManager.camera3DHeight = parseFloat(cameraHeightSlider.value);
            if (StateManager.view3D) generator.render();
          });
        }

        if (cameraFovSlider) {
          cameraFovSlider.addEventListener('input', function() {
            cameraFovValue.textContent = cameraFovSlider.value + '°';
            StateManager.camera3DFOV = parseFloat(cameraFovSlider.value);
            if (StateManager.view3D) generator.render();
          });
        }

        if (cameraAngleSlider) {
          cameraAngleSlider.addEventListener('input', function() {
            cameraAngleValue.textContent = cameraAngleSlider.value + '°';
            StateManager.camera3DAngle = parseFloat(cameraAngleSlider.value) * Math.PI / 180;
            if (StateManager.view3D) generator.render();
          });
        }

        if (buildingCountSlider) {
          // Update slider max based on actual building count
          buildingCountSlider.addEventListener('input', function() {
            StateManager.buildingCount = parseInt(buildingCountSlider.value);
            const maxValue = parseInt(buildingCountSlider.max);
            buildingCountValue.textContent = buildingCountSlider.value === buildingCountSlider.max ? 'All' : buildingCountSlider.value;
            if (StateManager.view3D) generator.render();
          });
        }

        document.getElementById('regenerate-btn').addEventListener('click', function() {
          // Reduced logging: regeneration triggered
          StateManager.seed = -1;
          StateManager.size = parseInt(sizeSlider.value);
          StateManager.plazaNeeded = document.getElementById('plaza-check').checked;
          StateManager.citadelNeeded = document.getElementById('citadel-check').checked;
          StateManager.wallsNeeded = document.getElementById('walls-check').checked;
          StateManager.showLabels = document.getElementById('labels-check').checked;
          StateManager.gridChaos = parseFloat(gridChaos.value);
          StateManager.sizeChaos = parseFloat(sizeChaos.value);
          StateManager.alleyWidth = parseFloat(alleyWidth.value);
          StateManager.streetWidth = parseFloat(streetWidth.value);
          StateManager.buildingGap = parseFloat(buildingGap.value);
          StateManager.wallThickness = parseFloat(wallThickness.value);
          generator.generate();
          seedInput.value = StateManager.seed;
        });

        document.getElementById('apply-btn').addEventListener('click', function() {
          // Reduced logging: apply settings triggered
          StateManager.size = parseInt(sizeSlider.value);
          StateManager.plazaNeeded = document.getElementById('plaza-check').checked;
          StateManager.citadelNeeded = document.getElementById('citadel-check').checked;
          StateManager.wallsNeeded = document.getElementById('walls-check').checked;
          StateManager.showLabels = document.getElementById('labels-check').checked;
          StateManager.gridChaos = parseFloat(gridChaos.value);
          StateManager.sizeChaos = parseFloat(sizeChaos.value);
          StateManager.alleyWidth = parseFloat(alleyWidth.value);
          StateManager.streetWidth = parseFloat(streetWidth.value);
          StateManager.buildingGap = parseFloat(buildingGap.value);
          StateManager.wallThickness = parseFloat(wallThickness.value);
          var newSeed = parseInt(seedInput.value);
          if (!isNaN(newSeed) && newSeed > 0) {
            StateManager.seed = newSeed;
          }
          generator.generate();
        });

        document.getElementById('export-btn').addEventListener('click', function() {
          var canvas = generator.canvas;
          var link = document.createElement('a');
          link.download = 'city-' + StateManager.seed + '.png';
          link.href = canvas.toDataURL('image/png');
          link.click();
        });

        document.getElementById('export-btn-float').addEventListener('click', function() {
          var canvas = generator.canvas;
          var link = document.createElement('a');
          link.download = 'city-' + StateManager.seed + '.png';
          link.href = canvas.toDataURL('image/png');
          link.click();
        });



        // Sync color pickers with text inputs
        const colorFields = ['paper', 'ink', 'roofs', 'water', 'greens', 'roads', 'walls', 'trees', 'labels', 'elements'];
        colorFields.forEach(field => {
          const textInput = document.getElementById(`color-${field}`);
          const colorPicker = document.getElementById(`color-${field}-pick`);
          
          textInput.addEventListener('input', () => {
            if (/^#[0-9A-F]{6}$/i.test(textInput.value)) {
              colorPicker.value = textInput.value;
            }
          });
          
          colorPicker.addEventListener('input', () => {
            textInput.value = colorPicker.value.toUpperCase();
          });
        });

        // Preset selector
        document.getElementById('color-preset').addEventListener('change', function() {
          const preset = colorPresets[this.value];
          if (preset) {
            Object.keys(preset).forEach(key => {
              const textInput = document.getElementById(`color-${key}`);
              const colorPicker = document.getElementById(`color-${key}-pick`);
              if (textInput && colorPicker) {
                textInput.value = preset[key];
                colorPicker.value = preset[key];
              }
            });
            // Apply the preset colors immediately
            applyColorScheme();
          }
        });

        // Tinting sliders
        document.getElementById('tint-method').addEventListener('change', function() {
          StateManager.tintMethod = this.value;
          if (generator && generator.render) generator.render();
        });
        
        // Use 'change' event for sliders to trigger render when user releases
        document.getElementById('tint-strength').addEventListener('input', function() {
          document.getElementById('tint-strength-value').textContent = this.value + '%';
          StateManager.tintStrength = parseInt(this.value);
        });
        document.getElementById('tint-strength').addEventListener('change', function() {
          StateManager.tintStrength = parseInt(this.value);
          console.log('Tint strength changed to:', StateManager.tintStrength);
          if (generator && generator.render) {
            console.log('Calling generator.render()');
            generator.render();
          }
        });
        
        document.getElementById('tint-weathering').addEventListener('input', function() {
          document.getElementById('tint-weathering-value').textContent = this.value + '%';
          StateManager.tintWeathering = parseInt(this.value);
        });
        document.getElementById('tint-weathering').addEventListener('change', function() {
          StateManager.tintWeathering = parseInt(this.value);
          if (generator && generator.render) generator.render();
        });

        // Visual options checkboxes
        document.getElementById('thin-lines-check').addEventListener('change', function() {
          StateManager.thinLines = this.checked;
          generator.render();
        });
        
        document.getElementById('tint-districts-check').addEventListener('change', function() {
          StateManager.tintDistricts = this.checked;
          generator.render();
        });
        
        document.getElementById('weathered-roofs-check').addEventListener('change', function() {
          StateManager.weatheredRoofs = this.checked;
          generator.render();
        });

        // Initialize UI color inputs with default preset values
        const defaultPreset = colorPresets.default;
        Object.keys(defaultPreset).forEach(key => {
          const textInput = document.getElementById(`color-${key}`);
          const colorPicker = document.getElementById(`color-${key}-pick`);
          if (textInput && colorPicker) {
            textInput.value = defaultPreset[key];
            colorPicker.value = defaultPreset[key];
          }
        });

        // Function to apply color scheme
        function applyColorScheme() {
          const PaletteClass = window.Palette;
          if (PaletteClass) {
            PaletteClass.paper = document.getElementById('color-paper').value;
            PaletteClass.dark = document.getElementById('color-ink').value;
            PaletteClass.roof = document.getElementById('color-roofs').value;
            PaletteClass.water = document.getElementById('color-water').value;
            PaletteClass.park = document.getElementById('color-greens').value;
            PaletteClass.light = document.getElementById('color-roads').value;
            PaletteClass.tree = document.getElementById('color-trees').value;
            PaletteClass.wallColor = document.getElementById('color-walls').value;
            PaletteClass.labelText = document.getElementById('color-labels').value;
            PaletteClass.insideCell = document.getElementById('color-elements').value;
            
            // Store tinting settings
            if (window.StateManager) {
              StateManager.tintMethod = document.getElementById('tint-method').value;
              StateManager.tintStrength = parseInt(document.getElementById('tint-strength').value);
              StateManager.tintWeathering = parseInt(document.getElementById('tint-weathering').value);
            }
            
            // Force re-render
            if (generator && generator.render) {
              generator.render();
            }
          }
        }
        
        // Apply default color scheme immediately on page load
        applyColorScheme();
        
        // Apply colors button
        document.getElementById('apply-colors-btn').addEventListener('click', applyColorScheme);

        // Save/Load buttons
        document.getElementById('save-colors-btn').addEventListener('click', function() {
          const palette = {};
          colorFields.forEach(field => {
            palette[field] = document.getElementById(`color-${field}`).value;
          });
          palette.tintMethod = document.getElementById('tint-method').value;
          palette.tintStrength = document.getElementById('tint-strength').value;
          palette.tintWeathering = document.getElementById('tint-weathering').value;
          palette.thinLines = document.getElementById('thin-lines-check').checked;
          palette.tintDistricts = document.getElementById('tint-districts-check').checked;
          palette.weatheredRoofs = document.getElementById('weathered-roofs-check').checked;
          
          localStorage.setItem('cityColorPalette', JSON.stringify(palette));
          alert('Color palette saved!');
        });

        document.getElementById('load-colors-btn').addEventListener('click', function() {
          const saved = localStorage.getItem('cityColorPalette');
          if (saved) {
            const palette = JSON.parse(saved);
            colorFields.forEach(field => {
              if (palette[field]) {
                document.getElementById(`color-${field}`).value = palette[field];
                document.getElementById(`color-${field}-pick`).value = palette[field];
              }
            });
            if (palette.tintMethod) document.getElementById('tint-method').value = palette.tintMethod;
            if (palette.tintStrength) document.getElementById('tint-strength').value = palette.tintStrength;
            if (palette.tintWeathering) document.getElementById('tint-weathering').value = palette.tintWeathering;
            if (palette.thinLines !== undefined) document.getElementById('thin-lines-check').checked = palette.thinLines;
            if (palette.tintDistricts !== undefined) document.getElementById('tint-districts-check').checked = palette.tintDistricts;
            if (palette.weatheredRoofs !== undefined) document.getElementById('weathered-roofs-check').checked = palette.weatheredRoofs;
            
            document.getElementById('tint-strength-value').textContent = document.getElementById('tint-strength').value + '%';
            document.getElementById('tint-weathering-value').textContent = document.getElementById('tint-weathering').value + '%';
            alert('Color palette loaded!');
          } else {
            alert('No saved palette found');
          }
        });
      }

      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        start();
      } else {
        document.addEventListener('DOMContentLoaded', start, { once: true });
      }
    })();
  </script>
</body>
</html>
